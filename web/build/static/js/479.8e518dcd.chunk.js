"use strict";(self.webpackChunknext_terminal=self.webpackChunknext_terminal||[]).push([[479],{16018:(e,t,a)=>{a.d(t,{A:()=>r});var s=a(93766),n=a(21215),c=a.n(n);class r{constructor(e){this.group="",this.getById=async e=>{let t=await s.A.get("/".concat(this.group,"/").concat(e));if(1===t.code)return t.data},this.getPaging=async e=>{let t=c().stringify(e),a=await s.A.get("/".concat(this.group,"/paging?").concat(t));return 1!==a.code?{}:a.data},this.getAll=async()=>{let e=await s.A.get("/".concat(this.group));return 1!==e.code?[]:e.data},this.create=async e=>1===(await s.A.post("/".concat(this.group),e)).code,this.updateById=async(e,t)=>1===(await s.A.put("/".concat(this.group,"/").concat(e),t)).code,this.deleteById=async e=>1===(await s.A.delete("/".concat(this.group,"/").concat(e))).code,this.group=e}}},80398:(e,t,a)=>{a.d(t,{A:()=>r});var s=a(16018),n=a(93766);class c extends s.A{constructor(){var e;super("assets"),e=this,this.GetAll=async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",a=await n.A.get("/".concat(e.group,"?protocol=").concat(t));return 1!==a.code?[]:a.data},this.connTest=async e=>{let t=await n.A.post("/".concat(this.group,"/").concat(e,"/tcping"));return 1!==t.code?[!1,t.message]:[t.data.active,t.data.message]},this.importAsset=async e=>{const t=new FormData;t.append("file",e);let a=await n.A.post("/".concat(this.group,"/import"),t,{"Content-Type":"multipart/form-data"});return 1!==a.code?[!1,a.message]:[!0,a.data]},this.changeOwner=async(e,t)=>1===(await n.A.post("/".concat(this.group,"/").concat(e,"/change-owner?owner=").concat(t))).code}}const r=new c},40479:(e,t,a)=>{a.r(t),a.d(t,{default:()=>q});var s=a(9950),n=a(68832),c=a(43637),r=a(12916),i=a(52735),l=a(56231),o=a(92759),d=a(48538),h=a(27666),u=a(16018),g=a(93766),m=a(21215),A=a.n(m);class p extends u.A{constructor(){super("jobs"),this.changeStatus=async(e,t)=>1!==(await g.A.post("/".concat(this.group,"/").concat(e,"/change-status?status=").concat(t))).code,this.exec=async e=>1!==(await g.A.post("/".concat(this.group,"/").concat(e,"/exec"))).code,this.getLogPaging=async(e,t)=>{let a=A().stringify(t),s=await g.A.get("/".concat(this.group,"/").concat(e,"/logs/paging?").concat(a));return 1!==s.code?{}:s.data},this.deleteLogByJobId=async e=>1!==(await g.A.delete("/".concat(this.group,"/").concat(e,"/logs"))).code}}const y=new p;var x=a(55902),j=a(87827),S=a(87427),I=a(99674),b=a(17811),f=a(90650),w=a(80398),v=a(41920),C=a(98409),O=a(44414);const{TextArea:k}=x.A,T=e=>{var t;let{visible:a,handleOk:n,handleCancel:c,confirmLoading:r,id:i}=e;const[l]=j.A.useForm();let[o,d]=(0,s.useState)("shell-job"),[h,u]=(0,s.useState)("all");(0,v.useQuery)("getJobById",(()=>y.getById(i)),{enabled:a&&C.A.hasText(i),onSuccess:e=>{if("shell-job"===e.func)try{e.shell=JSON.parse(e.metadata).shell}catch(t){e.shell=""}e.resourceIds&&(e.resourceIds=e.resourceIds.split(",")),l.setFieldsValue(e),u(e.mode),d(e.func)}});let g=(0,v.useQuery)("resQuery",(()=>w.A.GetAll("ssh"))),m=null===(t=g.data)||void 0===t?void 0:t.map((e=>({label:e.name,value:e.id})));return(0,O.jsx)(S.A,{title:i?"\u66f4\u65b0\u8ba1\u5212\u4efb\u52a1":"\u65b0\u5efa\u8ba1\u5212\u4efb\u52a1",visible:a,maskClosable:!1,destroyOnClose:!0,onOk:()=>{l.validateFields().then((async e=>{console.log(e),e.resourceIds&&(e.resourceIds=e.resourceIds.join(",")),l.resetFields(),n(e)}))},onCancel:()=>{l.resetFields(),c()},confirmLoading:r,okText:"\u786e\u5b9a",cancelText:"\u53d6\u6d88",children:(0,O.jsxs)(j.A,{form:l,labelCol:{span:6},wrapperCol:{span:14},initialValues:{func:"shell-job",mode:"all"},children:[(0,O.jsx)(j.A.Item,{name:"id",noStyle:!0,children:(0,O.jsx)(x.A,{hidden:!0})}),(0,O.jsx)(j.A.Item,{label:"\u4efb\u52a1\u7c7b\u578b",name:"func",rules:[{required:!0,message:"\u8bf7\u9009\u62e9\u4efb\u52a1\u7c7b\u578b"}],children:(0,O.jsxs)(I.A,{onChange:e=>{d(e)},children:[(0,O.jsx)(I.A.Option,{value:"shell-job",children:"Shell\u811a\u672c"}),(0,O.jsx)(I.A.Option,{value:"check-asset-status-job",children:"\u8d44\u4ea7\u72b6\u6001\u68c0\u6d4b"})]})}),(0,O.jsx)(j.A.Item,{label:"\u4efb\u52a1\u540d\u79f0",name:"name",rules:[{required:!0,message:"\u8bf7\u8f93\u5165\u4efb\u52a1\u540d\u79f0"}],children:(0,O.jsx)(x.A,{autoComplete:"off",placeholder:"\u8bf7\u8f93\u5165\u4efb\u52a1\u540d\u79f0"})}),"shell-job"===o?(0,O.jsx)(j.A.Item,{label:"Shell\u811a\u672c",name:"shell",rules:[{required:!0,message:"\u8bf7\u8f93\u5165Shell\u811a\u672c"}],children:(0,O.jsx)(k,{autoSize:{minRows:5,maxRows:10},placeholder:"\u5728\u6b64\u5904\u586b\u5199Shell\u811a\u672c\u5185\u5bb9"})}):void 0,(0,O.jsx)(j.A.Item,{label:"cron\u8868\u8fbe\u5f0f",name:"cron",rules:[{required:!0,message:"\u8bf7\u8f93\u5165cron\u8868\u8fbe\u5f0f"}],children:(0,O.jsx)(x.A,{placeholder:"\u8bf7\u8f93\u5165cron\u8868\u8fbe\u5f0f"})}),(0,O.jsx)(j.A.Item,{label:"\u8d44\u4ea7\u9009\u62e9",name:"mode",rules:[{required:!0,message:"\u8bf7\u9009\u62e9\u8d44\u4ea7"}],children:(0,O.jsxs)(b.Ay.Group,{onChange:async e=>{u(e.target.value)},children:[(0,O.jsx)(b.Ay,{value:"all",children:"\u5168\u90e8\u8d44\u4ea7"}),(0,O.jsx)(b.Ay,{value:"custom",children:"\u81ea\u5b9a\u4e49"}),(0,O.jsx)(b.Ay,{value:"self",children:"\u672c\u673a"})]})}),"custom"===h&&(0,O.jsx)(f.A,{tip:"\u52a0\u8f7d\u4e2d...",spinning:g.isLoading,children:(0,O.jsx)(j.A.Item,{label:"\u5df2\u9009\u62e9\u8d44\u4ea7",name:"resourceIds",rules:[{required:!0}],children:(0,O.jsx)(I.A,{mode:"multiple",allowClear:!0,placeholder:"\u8bf7\u9009\u62e9\u8d44\u4ea7",options:m})})})]})})};var E=a(4159),N=a.n(E),L=a(99019);const R=s.createRef(),B=e=>{let{visible:t,handleCancel:a,id:n}=e,[c,r]=(0,s.useState)(!1);return(0,O.jsx)("div",{children:(0,O.jsx)(L.A,{title:"\u8ba1\u5212\u4efb\u52a1\u65e5\u5fd7",placement:"right",width:.9*window.innerWidth,closable:!0,maskClosable:!0,onClose:a,open:t,children:t?(0,O.jsx)(h.A,{columns:[{dataIndex:"index",valueType:"indexBorder",width:48},{title:"\u6267\u884c\u65f6\u95f4",dataIndex:"timestamp",key:"timestamp",hideInSearch:!0,sorter:!0},{title:"\u65e5\u5fd7",dataIndex:"message",key:"message",hideInSearch:!0,valueType:"code"}],actionRef:R,request:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,a="",s="";Object.keys(t).length>0&&(a=Object.keys(t)[0],s=Object.values(t)[0]);let c={pageIndex:e.current,pageSize:e.pageSize,name:e.name,field:a,order:s},r=await y.getLogPaging(n,c);return{data:r.items,success:!0,total:r.total}},rowKey:"id",search:!1,pagination:{defaultPageSize:5,pageSizeOptions:[5,10,20,50,100],showSizeChanger:!0},dateFormatter:"string",headerTitle:"\u8ba1\u5212\u4efb\u52a1\u65e5\u5fd7",toolBarRender:()=>[(0,O.jsx)(d.A,{type:"primary",loading:c,danger:!0,onClick:async()=>{r(!0),await y.deleteLogByJobId(n),R.current.reload(),r(!1)},children:"\u6e05\u7a7a"},"button")]}):void 0})})};var _=a(27891),F=a(68201),G=a(50070);const{Content:z}=n.A,P=s.createRef(),J=y,q=()=>{let[e,t]=(0,s.useState)(!1),[a,n]=(0,s.useState)(!1),[u,g]=(0,s.useState)(void 0),[m,A]=(0,s.useState)(!1),[p,y]=(0,s.useState)([]);const[x,j]=(0,_.j)(_.A.JOB),S=[{dataIndex:"index",valueType:"indexBorder",width:48},{title:"\u4efb\u52a1\u540d\u79f0",dataIndex:"name",key:"name",sorter:!0},{title:"\u72b6\u6001",dataIndex:"status",key:"status",hideInSearch:!0,render:(e,t,a)=>(0,O.jsx)(c.A,{disabled:!(0,G.as)("job-change-status"),checkedChildren:"\u5f00\u542f",unCheckedChildren:"\u5173\u95ed",checked:"running"===e,onChange:e=>I(t.id,e?"running":"not-running",a)})},{title:"\u4efb\u52a1\u7c7b\u578b",dataIndex:"func",key:"func",hideInSearch:!0,render:(e,t)=>{switch(e){case"check-asset-status-job":return(0,O.jsx)(r.A,{color:"green",children:"\u8d44\u4ea7\u72b6\u6001\u68c0\u6d4b"});case"shell-job":return(0,O.jsx)(r.A,{color:"volcano",children:"Shell\u811a\u672c"});default:return""}}},{title:"cron\u8868\u8fbe\u5f0f",dataIndex:"cron",key:"cron",hideInSearch:!0},{title:"\u521b\u5efa\u65e5\u671f",dataIndex:"created",key:"created",hideInSearch:!0,render:(e,t)=>(0,O.jsx)(i.A,{title:e,children:N()(e).fromNow()}),sorter:!0},{title:"\u6700\u540e\u6267\u884c\u65e5\u671f",dataIndex:"updated",key:"updated",hideInSearch:!0,render:(e,t)=>"0001-01-01 00:00:00"===e?"-":(0,O.jsx)(i.A,{title:e,children:N()(e).fromNow()}),sorter:!0},{title:"\u64cd\u4f5c",valueType:"option",key:"option",render:(e,a,s,n)=>[(0,O.jsx)(F.A,{menu:"job-run",children:(0,O.jsx)("a",{disabled:p[s],onClick:()=>b(a.id,s),children:"\u6267\u884c"},"exec")},"job-run"),(0,O.jsx)(F.A,{menu:"job-log",children:(0,O.jsx)("a",{onClick:()=>f(a.id),children:"\u65e5\u5fd7"},"logs")},"job-log"),(0,O.jsx)(F.A,{menu:"job-edit",children:(0,O.jsx)("a",{onClick:()=>{t(!0),g(a.id)},children:"\u7f16\u8f91"},"edit")},"job-edit"),(0,O.jsx)(F.A,{menu:"job-del",children:(0,O.jsx)(l.A,{title:"\u60a8\u786e\u8ba4\u8981\u5220\u9664\u6b64\u884c\u5417?",onConfirm:async()=>{await J.deleteById(a.id),P.current.reload()},okText:"\u786e\u8ba4",cancelText:"\u53d6\u6d88",children:(0,O.jsx)("a",{className:"danger",children:"\u5220\u9664"},"delete")},"confirm-delete")},"job-del")]}],I=async(e,t,a)=>{await J.changeStatus(e,t),P.current.reload()},b=async(e,t)=>{o.Ay.loading({content:"\u6b63\u5728\u6267\u884c...",key:e,duration:30}),p[t]=!0,y(p.slice()),await J.exec(e),o.Ay.success({content:"\u6267\u884c\u6210\u529f",key:e}),p[t]=!1,y(p.slice()),P.current.reload()},f=e=>{A(!0),g(e)};return(0,O.jsx)("div",{children:(0,O.jsxs)(z,{className:"page-container",children:[(0,O.jsx)(h.A,{columns:S,actionRef:P,columnsState:{value:x,onChange:j},request:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,a="",s="";Object.keys(t).length>0&&(a=Object.keys(t)[0],s=Object.values(t)[0]);let n={pageIndex:e.current,pageSize:e.pageSize,name:e.name,field:a,order:s},c=await J.getPaging(n),r=c.items;for(let i=0;i<r.length;i++)p.push(!1);return y(p.slice()),{data:r,success:!0,total:c.total}},rowKey:"id",search:{labelWidth:"auto"},pagination:{defaultPageSize:10},dateFormatter:"string",headerTitle:"\u8ba1\u5212\u4efb\u52a1\u5217\u8868",toolBarRender:()=>[(0,O.jsx)(F.A,{menu:"job-add",children:(0,O.jsx)(d.A,{type:"primary",onClick:()=>{t(!0)},children:"\u65b0\u5efa"},"button")})]}),(0,O.jsx)(T,{id:u,visible:e,confirmLoading:a,handleCancel:()=>{t(!1),g(void 0)},handleOk:async e=>{n(!0);try{let a;"shell-job"===e.func&&(e.metadata=JSON.stringify({shell:e.shell})),a=e.id?await J.updateById(e.id,e):await J.create(e),a&&t(!1),P.current.reload()}finally{n(!1)}}}),(0,O.jsx)(B,{id:u,visible:m,handleCancel:()=>{A(!1),g(void 0)}})]})})}},68201:(e,t,a)=>{a.d(t,{A:()=>n});var s=a(50070);const n=e=>{let{menu:t,children:a}=e;if(Array.isArray(t)){if((0,s.as)(...t))return a}else if((0,s.as)(t))return a}},27891:(e,t,a)=>{a.d(t,{A:()=>r,j:()=>i});var s=a(98409),n=a(9950);let c=new class{constructor(){this.ASSET="cs-asset",this.CREDENTIAL="cs-credential",this.COMMAND="cs-command",this.ACCESS_GATEWAY="cs-access-gateway",this.ONLINE_SESSION="cs-online-session",this.OFFLINE_SESSION="cs-offline-session",this.LOGIN_LOG="cs-login-log",this.STORAGE_LOG="cs-storage-log",this.JOB="cs-job",this.STORAGE="cs-storage",this.LOGIN_POLICY="cs-login-policy",this.ACCESS_SECURITY="cs-access-security",this.USER="cs-user",this.ROLE="cs-role",this.USER_GROUP="cs-user-group",this.COMMAND_FILTER="cs-command-filter",this.STRATEGY="cs-strategy"}};const r=c,i=e=>{let[t,a]=(0,n.useState)(l(e));return[t,t=>{new Promise((e=>{a(t),e(t)})).then((t=>{o(e,t)}))}]},l=e=>{switch(e){case c.ASSET:case c.CREDENTIAL:case c.COMMAND:case c.ACCESS_GATEWAY:case c.ONLINE_SESSION:case c.OFFLINE_SESSION:}return d(e,{})},o=(e,t)=>{localStorage.setItem(e,JSON.stringify(t))},d=(e,t)=>{let a=localStorage.getItem(e);if(!s.A.hasText(a))return t;try{return JSON.parse(a)}catch(n){return t}}},98409:(e,t,a)=>{a.d(t,{A:()=>s});const s=new class{constructor(){this.hasText=function(e){return!(void 0===e||null===e||0===e.length)},this.zeroPad=function(e,t){let a=e.toString();for(;a.length<t;)a="0"+a;return a}}}}}]);